- dextension 중 django를 깔면 쉽게 장고 이용가능
- 그러다 흠은 스니펫이 돌아가지 않는다.

# FORM 

- 우선 셋팅 후 앱 아래 `forms.py`를 만든다.

- ```python
  from django import forms
  from .models import Board
  
  #이름지을때 앱의 이름의 Form이라 지어주자.
  class BoardForm(forms.ModleForm): #일반적으로는 forms.Form이지만 이번엔 modelform을 받자
      class Meta:
          model = Board
          fields = ['title' ,'content'] #요 두개만 만든다. 
  
  ```

- 셋팅이 완료!

  - CRUD를 만들어보자

- urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
  ]
  ```

- view.py

- ```python
  from django.shortcuts import render
  from .forms import BoardForm
  
  # Create your views here.
  def index(request):
      return render(request , "boards/index.html")
  
  def new(reqeust):
      #form.py를 사용할 것이다.
  
      form = BoardForm()  #form 변수에 BoardForm 불러왔다.
      context= {
          'form' : form
      }
  
      return render(reqest, "boards/new.html" , context)
  
  ```

- new.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <form action='' method = 'POST'>
          {{ form }}
      {% csrf_token %}
      <input type= 'submit' value="새글쓰기">
  </form>
  
  {% endblock %}
  ```

- 받은 form값을 불러오기만 하면된다!

- ![image-20191126101020760](9.FORMs(django6).assets/image-20191126101020760.png)

- 안이쁘니까

- new.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <form action='' method = 'POST'>
          {{ form.as_p }}
      {% csrf_token %}
      <input type= 'submit' value="새글쓰기">
  </form>
  
  {% endblock %}
  ```

- ![image-20191126101058230](9.FORMs(django6).assets/image-20191126101058230.png)

- 요롷게 바뀐다. `{{form.as_p}}` 하면 p태크고 감싼다는 뜻으로 아까보다는 조금~이뻐진것을 확인

- 근데 이것도 안 이쁘므로

- ```cmd
  student@M1504 MINGW64 ~/Documents/GitHub/STUDY/Python/Framword(Django)/django-form (master)
  $ pip install django-crispy-forms
  #를 설치하자.
  ```

- 자세한 것은 [여기를]( https://django-crispy-forms.readthedocs.io/en/latest/ ) 참조~

- 그 후 settings.py에

- ```python
  # Application definition
  
  INSTALLED_APPS = [
      'boards',
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
      'crispy_forms', #추가해준다!
  ]
  ```

- 

- new.html

- ```html
  {% extends 'base.html' %}
  {% load crispy_forms_tags %} <!--추가!-->
  {% block body %}
  <form action='' method = 'POST'>
      {% csrf_token %}
      {{ form|crispy }} <!-- 추가1-->
      
      <input type= 'submit' value="새글쓰기">
  </form>
  
  {% endblock %}
  ```

- ![image-20191126101802185](9.FORMs(django6).assets/image-20191126101802185.png)

- 요롷게 이뻐졌다.

- ```python
  from django.shortcuts import render , redirect
  from .forms import BoardForm
  from .models import Board
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  
  def new(request):
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save() #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  ```

- index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li>{{board.title}}</li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  
  {% endblock %}
  
  ```

- ![image-20191126103004545](9.FORMs(django6).assets/image-20191126103004545.png)

- 이렇게 나오게 된다.

- 이제 read부분! detail만들자

- 클릭했을때 해당글이 나와야 한다.

- index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a></li> 
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  
  {% endblock %}
  
  ```

- urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
  ]
  ```

- veiw.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  
  def new(request):
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save() #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html')
  ```

- detail.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  {% endblock %}
  ```

- 수정하기 만들어 보자(detail.html)

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  {% endblock %}
  ```

- urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
      path('edit/<int:b_id>/', views.edit , name = "edit"),
  ]
  ```

- view.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  
  def new(request):
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save() #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  ```

- edit.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
      {{ form}}
  {% endblock %}
  ```

- 

- ![image-20191126104640882](9.FORMs(django6).assets/image-20191126104640882.png)

- 오홍 잘 나온다.

- edit.html

- ```html
  {% extends 'base.html' %}
  {% load crispy_forms_tags %}
  {% block body %}
  <form action='' method = 'POST'>
      {% csrf_token %}
      {{ form|crispy }}
      <input type= 'submit' value = "수정하기">
  </form>
  
  {% endblock %}
  ```

- ![image-20191126104904849](9.FORMs(django6).assets/image-20191126104904849.png)

- 이쁘게 나왔다

- view.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  
  def new(request):
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save() #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  ```

- 삭제하기 

- detail.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  <a href="{% url 'boards:delete' board.id %}">삭제하기</a>
  {% endblock %}
  ```

- urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
      path('edit/<int:b_id>/', views.edit , name = "edit"),
      path('delete/<int:b_id>/' , views.delete , name = 'delete'),
  ]
  ```

- views.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  
  def new(request):
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save() #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
      board = get_object_or_404(Board , id=b_id)
      
      if request.method=="POST":
          board.delete()
          return redirext("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  ```

- ![image-20191126111100297](9.FORMs(django6).assets/image-20191126111100297.png)

- 지금은 a태그라 삭제가 안된다

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  <form action='{% url "boards:delete" board.id %}' method = 'POST'>
      {% csrf_token %}
      <a href="#" onclick="this.parentNode.submit()">삭제하기</a>
      
  </form>
  
  {% endblock %}
  ```

- 삭제 완료!



# 회원가입

- 이미 장고에서 로직을 이미 다 만들어 놨다
- admin으로 들어갈때 로그인 가능했다. 그래서 그대로 가져다 써보자.



- 앱을 하나 새로 만들자

- ```cmd
  student@M1504 MINGW64 ~/Documents/GitHub/STUDY/Python/Framword(Django)/django-form (master)
  $ python manage.py startapp accounts
  ```

- config / settings.py

- ```python
  
  # Application definition
  
  INSTALLED_APPS = [
      'accounts',
      'boards',
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
      'crispy_forms',
  ]
  ```

- config / urls.py

- ```python
  from django.contrib import admin
  from django.urls import path, include
  
  urlpatterns = [
      path('accounts/' , include('accounts.urls')),
      path('boards/' , include('boards.urls')),
      path('admin/', admin.site.urls),
      
  ]
  
  ```

- accounts 의 urls.py

- ```python
  from django.urls import path
  
  app_name='accounts'
  urlpatterns=[
      
  ]
  ```

- boards / index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a></li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  <a href="{% url 'accounts:signup' %}">회원가입 </a>
  
  
  {% endblock %}
  
  
  
  ```

- accounts/ urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='accounts'
  urlpatterns=[
      path('signup/' , views.signup, name="signup")   ,
  ]
  ```

- views.py

- ```python
  from django.shortcuts import render
  from django.contrib.auth.forms import UserCreationForm
  
  # Create your views here.
  def signup(request):
      form =UserCreationForm()
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  ```

- signup.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  {{ form }}
  {% endblock %}
  ```

- ![image-20191126112651905](9.FORMs(django6).assets/image-20191126112651905.png)

- 이렇게 나타난다 회원가입 누르면!

- 이쁘게 만들기 위해서

- ```cmd
  student@M1504 MINGW64 ~/Documents/GitHub/STUDY/Python/Framword(Django)/django-form (master)
  $ pip install django.bootstrap4
  ```

- 사용 방법은 [사이트]( https://django-bootstrap4.readthedocs.io/en/latest/ )를 참고하자

- 여기는 installed app에 넣어야 한다.

- settings.py

- ```python
  
  # Application definition
  
  INSTALLED_APPS = [
      'accounts',
      'boards',
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
      'crispy_forms',
      'bootstrap4',
  ]
  ```

- accounts/ signup.html

- ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
  {% bootstrap_form form %}}
  {% endblock %}
  ```

- ![image-20191126113205553](9.FORMs(django6).assets/image-20191126113205553.png)

- 요렇게 나온다.

- 버튼을 만들 수 있는데

- signup.html

- ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
  <form action='' method = 'POST'>
      {% csrf_token %}
      {% bootstrap_form form %}}
      {% buttons %}
      <!---버튼 사용 방법은 첫번째 -->
          <button type="submit" class="btn btn-primary">회원가입</button>
      {% endbuttons %}
      <!---버튼 사용 방법은 첫번째 -->
      {% buttons  submit="회원가입_2" reset="다시입력" %}
      {% endbuttons %}
  </form>
  
  {% endblock %}
  ```

- ![image-20191126113625455](9.FORMs(django6).assets/image-20191126113625455.png)

- 등록하기~

- accounts / view.py

- ```python
  from django.shortcuts import render
  from django.contrib.auth.forms import UserCreationForm
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          
      form =UserCreationForm()
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  ```

- 설치한다!

- ```cmd
  pip install ipython
  ```

- accounts/view.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          embed()
          if form.is_valid():
              form.save() 
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  ```

- 서버를 실행하고 회원가입 누르면!!!!!!

- ![image-20191126114414107](9.FORMs(django6).assets/image-20191126114414107.png)

- 가 뜬다!

- 다시 view.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          embed()
          if form.is_valid():
              form.save() 
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  ```

- 에서 가입을 하고!

- ![image-20191126114830454](9.FORMs(django6).assets/image-20191126114830454.png)

- form data라고 하면 회원가입한 내용을 확인 할 수 있따!

- 



# 로그인

- boards/index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a></li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  <a href="{% url 'accounts:signup' %}">회원가입 </a>
  <a href="{% url 'accounts:login' %}">로그인</a>
  
  
  {% endblock %}
  
  
  
  
  
  
  
  ```

- accounts.urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='accounts'
  urlpatterns=[
      path('signup/' , views.signup, name="signup")   ,
      path('login/' , views.login, name="login"),
  ]
  ```

- accounts/ views.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          # embed()
          if form.is_valid():
              form.save() 
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  
  def login(request):
      form  = AuthenticationForm()
      context = {
          'form' : form
      }
      return render(request, 'accounts/login.html' , context)
  
  ```

- login.html

- ```html
  
  ```

- accounts.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
  from django.contrib.auth import login as auth_login
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          # embed()
          if form.is_valid():
              form.save() 
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  
  def login(request):
  
      if request.method=="POST":
          form = AuthenticationForm(request, request, POST)
          if form.is_valid():
              auth_login(request, form.get_user())
              return redirect('boards:index')
          else:
              form = AuthenticationForm()
      form  = AuthenticationForm()
  
  
      context = {
          'form' : form
      }
      return render(request, 'accounts/login.html' , context)
  
  ```

- a

- a

- base.html

- ```html
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Document</title>
  </head>
  <body>
      <div class="container" >
          <h3>안녕하세요, {{ user.username }}</h3>
      </div>
      {% block body %}
      {% endblock %}
          <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
          <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    
  </body>
  </html>
  ```

- 

# 로그아웃

- 세션을 지우는게 로그아웃이다.

- boards/ index.py

- ```python
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a></li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  <a href="{% url 'accounts:signup' %}">회원가입 </a>
  <a href="{% url 'accounts:login' %}">로그인</a>
  <a href="{% url 'accounts:logout' %}">로그아웃</a>
  
  
  {% endblock %}
  
  
  
  ```

- accounts/ urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='accounts'
  urlpatterns=[
      path('signup/' , views.signup, name="signup")   ,
      path('login/' , views.login, name="login"),
      path('logout/' , views.logout , name="logout"),
  ]
  ```

- accounts/ views.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
  from django.contrib.auth import login as auth_login
  from django.contrib.auth import logout as auth_logout
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          # embed()
          if form.is_valid():
              form.save() 
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  
  def login(request):
  
      if request.method=="POST":
          form = AuthenticationForm(request, request.POST)
          if form.is_valid():
              auth_login(request, form.get_user())
              return redirect('boards:index')
          else:
              form = AuthenticationForm()
      form  = AuthenticationForm()
  
  
      context = {
          'form' : form
      }
      return render(request, 'accounts/login.html' , context)
  
  def logout(request):
      if request.method=="POST": #POST일때만 동작 하겠끔.
  
          auth_logout(request)
  
      return redirect('boards:index')
  
  
  ```

- boards/ index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a></li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  <a href="{% url 'boards:new' %}">New</a>
  {% if user.is_authenticated %}
  
  <form action='{% url "accounts:logout" %}' method = 'POST'>
          {% csrf_token %}
          <a href="#" onclick = "this.parentNode.submit()">로그아웃</a>
  {% else %}
  <a href="{% url 'accounts:signup' %}">회원가입 </a>
  <a href="{% url 'accounts:login' %}">로그인</a>
  {% endif %}
  
      
  </form>
  
  
  {% endblock %}
  
  
  
  
  
  
  
  ```

- base.html

- ```html
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Document</title>
  </head>
  <body>
      {% if user.is_authenticated %}
      <div class="container" >
          <h3>안녕하세요, {{ user.username }}</h3>
      {% else %}
          <h3>로그인 해주세요</h3>
      
      </div>
      {% endif %}
      {% block body %}
      {% endblock %}
          <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
          <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    
  </body>
  </html>
  ```

- 로그인 되었을때만 로그인 이름이 나오게 된다.

- user.is_active: 로그인 허용 여부

- user.is_

- ㅇ

- ㅇ

- ㅇ

- 자동 로그인 가능하게!!!!!

- accounts/ views.p

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
  from django.contrib.auth import login as auth_login
  from django.contrib.auth import logout as auth_logout
  from IPython import embed
  
  # Create your views here.
  def signup(request):
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          # embed()
          if form.is_valid():
              user = form.save() 
              #회원가입하고 이 정보를 유지하기 위해서 추가부분!!!!!!!!!!!!!!!
              auth_login(request, user)
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form
      }
      return render(request , 'accounts/signup.html' , context)
  
  def login(request):
  
      if request.method=="POST":
          form = AuthenticationForm(request, request.POST)
          if form.is_valid():
              auth_login(request, form.get_user())
              return redirect('boards:index')
          else:
              form = AuthenticationForm()
      form  = AuthenticationForm()
  
  
      context = {
          'form' : form
      }
      return render(request, 'accounts/login.html' , context)
  
  def logout(request):
      if request.method=="POST": #POST일때만 동작 하겠끔.
  
          auth_logout(request)
  
      return redirect('boards:index')
  
  
  ```

- 이렇게 되면 회원가입하고 바로 로그인이 된다!





- 로그인을 하고 다른 부분을 막을 수 있도록!!!



### form 합치기

- auth_form.html

- ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
  <h1>{{label}}</h1>
  
  
  <form action='' method = 'POST'>
      {% csrf_token %}
      {% bootstrap_form form %}
  {% if request.resolver_match.url_name == 'signup' %} <!--이리 쓰면 url이름을 받게 된다. url별로 -->
      {% buttons submit="회원 가입" %}
      {% endbuttons %}
  {% elif request.resolver_match.url_name == 'login' %}
      {% buttons submit="로그인" %}
      {% endbuttons %}
  {% elif request.resolver_match.url_name == 'edit' %}
      {% buttons submit="수정하기" %}
      {% endbuttons %}
  {% else %}
      {% buttons submit="비번 변경" %}
      {% endbuttons %}
  {% endif %}
     
  </form>
  {% if request.resolver_match.url_name == 'edit' %}
  <form action='{% url 'accounts:delete' %}' method = 'POST'>
          {% csrf_token %}
          <a href="#" onclick='this.parentNode.submit()'>회원탈퇴</a>
          
       </form>
  {% endif %}
  
  {% endblock %}
  ```

- views.py

- ```python
  from django.shortcuts import render , redirect
  from django.contrib.auth.forms import UserCreationForm, AuthenticationForm, UserChangeForm , PasswordChangeForm
  from django.contrib.auth import login as auth_login
  from django.contrib.auth import logout as auth_logout
  from IPython import embed
  from .forms import UserCustomChangedForm
  from django.contrib.auth import update_session_auth_hash as update_session
  from django.contrib.auth.decorators import login_required
  # Create your views here.
  def signup(request):
      if request.user.is_authenticated:
          return redirect('boards:index')  #로그인 한사람은 회원가입 다시 못하도록!!!
  
      if request.method=="POST":
          form=UserCreationForm(request.POST) #폼에 해당부분이 채워져있을 것이다.
          # embed()
          if form.is_valid():
              user = form.save() 
              #회원가입하고 이 정보를 유지하기 위해서
              auth_login(request, user)
              return redirect("boards:index")
      else:
          form=UserCreationForm()
          # embed()
  
    
      context= {
          'form' :form,
          'label' : "회원가입"
      }
      return render(request , 'accounts/auth_form.html' , context)
  
  def login(request):
      if request.user.is_authenticated:
          return redirect('boards:index')
      if request.method=="POST":
          form = AuthenticationForm(request, request.POST)
          if form.is_valid():
              auth_login(request, form.get_user())
              return redirect(request.GET.get('next') or 'boards:index') #next로 받을게 있따면....
              #실제 글을 쓰려할떄 로그인이 필요하다면 로그인 페이지 갔따가 다시 NEW로 가는 NEXT가 있기 때문에 바로 이동 가능하게 해준다!
          else:
              form = AuthenticationForm()
      form  = AuthenticationForm()
  
  
      context = {
          'form' : form,
          'label' : '로그인'
      }
      return render(request, 'accounts/auth_form.html' , context)
  
  def logout(request):
      if request.method=="POST": #POST일때만 동작 하겠끔.
  
          auth_logout(request)
  
      return redirect('boards:index')
  
  def edit(request):
      if request.method =="POST":
          form = UserCustomChangedForm(request.POST, instance=request.user) #user정보 넣기 위해 instance를 넣는다.
          if form.is_valid():
              form.save()
              return redirect("boards:index")
      else:
      # 유저 정보 수정 하기
      # form = UserChangeForm()
          form = UserCustomChangedForm() #이렇게 해야 이상한게 안뜬다 즉 이용자에게 적절한것이 뜬다.
  
  
      context= {
          'form' : form,
          'label' : '회원 정보 수정'
      }
      return render(request , 'accounts/auth_form.html' , context)
  
  def chg_pwd(request):
      if request.method=="POST":
          form = PasswordChangeForm(request.user, request.POST) # 패스워드도 폼이 있기 때문에 import하고 불러온다.
          #또한 ()안에 들어가는 인자 위치가 저 순서여야 한다.
          if form.is_valid():
              user = form.save()
              update_session(request.user) #import 해야 쓸 수 있따.
              return redirect('accounts:edit')
      else:
          form = PasswordChangeForm(request.user)
      context = {
          'form' : form,
          'label' : "비번 수정"
      }
      return render(request , 'accounts/auth_form.html' , context)
  @login_required
  def delete(request):
      if request.method=="POST":
          request.user.delete()
  
      return redirect('boards:index')
      
  
  
  ```

- 이렇게 하면 폼을 여러개 만들지 않아도 된다! html하나로 가능!

### 내가 쓴 글은 나만이 수정할 수 있도록

- boards/models.py

- ```python
  from django.db import models
  from django.conf import settings #여기에서 import 받아서
  # Create your models here.
  class Board(models.Model):
      title  = models.CharField(max_length=30)
      content = models.TextField()
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
  
      def __str__(self):
          return self.title
  ```

- 이제 migrations

- ```cmd
  student@M1504 MINGW64 ~/Documents/GitHub/STUDY/Python/Framword(Django)/django-form (master)
  $ python manage.py makemigrations
  You are trying to add a non-nullable field 'user' to board without a default; we can't do that (the database needs something to populate existing rows).
  Please select a fix:
   1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
   2) Quit, and let me add a default in models.py
  Select an option: 1 #직접 default를 설정하겠다! 란 뜻 2는 자동
  Please enter the default value now, as valid Python
  The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now
  Type 'exit' to exit this prompt
  >>> 1
  Migrations for 'boards':
    boards\migrations\0002_board_user.py
      - Add field user to board
  (venv) 
  student@M1504 MINGW64 ~/Documents/GitHub/STUDY/Python/Framword(Django)/django-form (master)
  $ python manage.py migrate
  Operations to perform:
    Apply all migrations: admin, auth, boards, contenttypes, sessions
  Running migrations:
    Applying boa # 추가!
    
  ```

- 이후에 유저 정보를 새 글 쓸때 넣어 주어야 하기 때문에

- view.py에서 new부분을 고쳐준다!

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  from django.contrib.auth.decorators import login_required
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
      board = get_object_or_404(Board , id=b_id)
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  ```

- 이제 새 글을 작성하면 잘 들어가 게 되며~ 이제는 각 글의 유저 정보를 불러와 보자.

- boards/index.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a> - {{board.user}}</li>
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  
  
  
  <form action='{% url "accounts:logout" %}' method = 'POST'>
      {% csrf_token %}
      <a href="{% url 'boards:new' %}">New</a><br>
      
  </form>
  
  {% endblock %}
  
  
  
  
  
  
  
  ```

- ![image-20191126162439076](9.FORMs(django6).assets/image-20191126162439076.png)

- 어떤 유저가 글을 썼는지 확인 가능!

- 이제 유저가 구분이 되고 현재 활동하는 유저는 request에 저장된다. 

- board/detail.html

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  {% if user == board.user %} <!--user는 현재 페이지를 띄운 user와 글의 유저(board.user)가 같은 사람인가? 란 뜻-->
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  <form action='{% url "boards:delete" board.id %}' method = 'POST'>
      {% csrf_token %}
      <a href="#" onclick="this.parentNode.submit()">삭제하기</a>
      
  </form>
  {% endif %}
  {% endblock %}
  ```

- 이리 하면

- 자신이 쓴 글 이외에는 삭제하기, 수정하기  글이 뜨지 않는다!

- 하지만 주소창에 쓰면 넘어가지기 때문에 막아줘야 한다

- boards/views.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm
  from .models import Board
  from django.contrib.auth.decorators import login_required
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
  
      context = {
          'board'  : board
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user == board.user:
          return redirect('boards.index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
          return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  ```

- 

***

# 복습

- 유저의 모델을 가지고 폼을 만들었다.
- `get_user_model()`이 장고에서 만든 유저 폼을 가져오는 함수이다.
- `UserCreationForm()`장고에서 미리 만들어 놓은 유저 폼 불러오기 함수.
- `import login as auth_login`을 통해 로그인 후 로그인 유지 하게 만들었다.
- `AuthenticationForm()`을 이용하여 로그인 화면 만들었다. form.is_valid()를 통해 유효성 검사
- `UserChangeForm()`을 이용하여 이용자 정보 수정이 가능한데 , 일부 바꾸면안되는 것까지 보여주므로 `forms.py`에서 `UserCustomChangeForm(UserChangeForm)`을 만들어 이를 이용하여 정보수정 내용을 제한한다.
- `PasswordChangeForm(request.user, request.POST)`로 불러오고 `form.is_valid()`를 통해 유효성 검사 하고  `import update_session_auth_hash`를 이용하여`update_session(request, user)`하면 로그인이 제대로 돌아감을 확인 할 수 있다.
- 회원 정보 삭제는 `request.user.delete()`로 하면 된다!
- `user.is_authenticated`로 로그인 여부를 확인 할수 있다.
- `@login_required`를 통해 로그인 필요시 자동 로그인 페이지 이동 가능.
  - `from django.contrib.auth.decorators import login_required`를 통해
- html을 합쳐서 이용하기도 했다. 비슷한 내용이 많아서 (자세한 사항은 위의 글을 참고)
  - `request.resolver.match.url_name `으로 url의 name을 가져올 수 있는데 이를 통해 분류
- 글 작성자만 글을 삭제하고 수정할 수 있겠끔 models.py에서 컬럼을 생성하고 옵션에 이를 넣어 `settings.AUTH_USER_MODEL`을 통해 유저이름을 가져올 수 있게 된다.
  - `get_user_model`은 user class를 리턴해 주는 거지만 위의 것은 String을 리턴해 준다. `get_user_model`의 문제점은 settings.py의 installed app 순서에 따라 유저 공간이 정해지는데 , 이 순서가 중요해서 순서가 달라지는 경우 못 읽어 잘 사용하지 않는다. \
  - `settings.AUTH_USER_MODEL`은 순서 상관없이 불러오기 때문에 이것을 더욱 많이 사용하게 된다!
- detail.html에서 (templates에서) `user(현 로그인 유저)==board.user(글 작성 유저)`가 일치하는 것만 노출 이 되도록!

***

# 댓글 넣기

- boards. models.py

- ```python
  from django.db import models
  from django.conf import settings
  # Create your models here.
  class Board(models.Model):
      title  = models.CharField(max_length=30)
      content = models.TextField()
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
  
      def __str__(self):
          return self.title
  
  class Comment(models.Model):
      comment = models.CharField(max_length=200) #댓글은 대게 200자가 length다.
      user = models.ForeignKey(settings.AUTH_USER_MODEL , on_delete=models.CASCADE) #장고에 있는 기본 settings를 외래키 연결
      board = models.ForeignKey(Board, on_delete=models.CASCADE)
      
      def __str__(self):
          return self.comment
  ```

- migrate해준다.

- boards / forms.py

- ```python
  from django import forms
  from .models import Board , Comment
  
  #이름지을때 앱의 이름의 Form이라 지어주자.
  class BoardForm(forms.ModelForm): #일반적으로는 forms.Form이지만 이번엔 modelform을 받자
      class Meta:
          model = Board
          fields = ['title' ,'content'] #요 두개만 만든다. 
  
  class CommentForm(forms.ModelForm):
      class Meta:
          model = Comment
          fields = ['comment'] #댓글만 있으면 되기 때문에~ comment만!튜플로도 만들수 있는데, ('comment',) 
                              #튜플은 하나만 있어도 꼬옥 , 를 찍어 주어야 한다.
  
          
  
  
  ```

- boards / admin.py

- ```python
  from django.contrib import admin
  from .models import Board, Comment
  
  # Register your models here.
  
  class CommentAdmin(admin.ModelAdmin):
      #처음에 보여지는 항목
      list_display = ['comment']
  
  admin.site.register(Board) #admin사이트에 등록! 이라고 외우자
  admin.site.register(Comment, CommentAdmin) #두개의 인자를 넣어서 등록 한다. 코멘트는 위에 설정 한 것 까지!
  
  
  
  ```

- boards/views.py 에 detail수정

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm , CommentForm
  from .models import Board
  from django.contrib.auth.decorators import login_required
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
      comment_form = CommentForm()# 댓글 보내기
  
      comments = board.comment_set.all()   #board에서는 역참고 할때는 _set을 붙여야 한다. 그래서 모든 값을 가져온다.
                                          # 자식입장에서는 부모가 누구인지 명확하기에 comment.board하면 부모를 불러올수 있다.
  
  
      context = {
          'board'  : board,
          'comment' : comment_form,
          'comments' : comments,
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  ```

- boards/ detail.html / 댓글 추가

- ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  <!--댓글 보여주기-->
  <hr>
  <h3>댓글</h3>
  {% for comment in comments %}
      <p>{{ comment.comment }}</p>
  {% empty %}
  <h4>댓글 작성해 주세요~</h4>
  {% endfor %}
  <hr>
  
  <form action='{% url "boards:new_comment" board.id %}' method = 'POST'> <!--부모의 아이디도 같이 넘긴다.-->
      {% csrf_token %}
      {% bootstrap_form comment_form %}
      {% buttons submit="댓글등록" %}
      {% endbuttons %}  
  </form>
  
  
  
  
  {% if user == board.user %} <!--user는 현재 페이지를 띄운 user와 글의 유저(board.user)가 같은 사람인가? 란 뜻-->
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  <form action='{% url "boards:delete" board.id %}' method = 'POST'>
      {% csrf_token %}
      <a href="#" onclick="this.parentNode.submit()">삭제하기</a>
      
  </form>
  {% endif %}
  {% endblock %}
  ```

- boads . urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
      path('edit/<int:b_id>/', views.edit , name = "edit"),
      path('delete/<int:b_id>/' , views.delete , name = 'delete'),
      path('new_comment/<int:b_id>/' , views.new_comment , name='new_comment'),
  ]
  ```

- boards/views.py    new_comment를 추가해준다~

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm , CommentForm
  from .models import Board
  from django.contrib.auth.decorators import login_required
  from django.views.decorators.http import require_POST
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
      comment_form = CommentForm()# 댓글 보내기
  
      comments = board.comment_set.all()   #board에서는 역참고 할때는 _set을 붙여야 한다. 그래서 모든 값을 가져온다.
                                          # 자식입장에서는 부모가 누구인지 명확하기에 comment.board하면 부모를 불러올수 있다.
  
  
      context = {
          'board'  : board,
          'comment' : comment_form,
          'comments' : comments,
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  @require_POST #POST로 왔을때만 이 함수 사용 가능!
  def new_comment(request, b_id):
      form = CommentForm(request.POST) #CommentForm에 request.POST내용이 들어 가게 된다.
  
      if form.is_valid(): #댓글이 200자 안으로 잘쓰였는지 확인!
          comment = form.save(commit=false) #DB바로 저장을 막는다!
          comment.board_id = b_id
          comment.user =request.user #현재 페이지를 작성하는 유저, 현재 접속한 user를 불러온다.
          comment.save()
          return redirect('boards:detail', b_id)
      else:
          board = Board.objects.get(id=b_id)
          comments = board.comment_set.all()
          context = {
              'board' : board,
              'comment_form' : form,
              'comments' : comments,
          }
          return render(request, 'boards/detail.html' , context)
  
  
  ```



# 댓글 삭제

- boards/ detail.html 댓글 삭제 추가!

- ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
  <table>
      <tr>
          <td>타이틀</td>
          <td>{{board.title}}</td>
      </tr>
      <tr>
          <td>내용</td>
          <td>{{board.content}}</td>
      </tr>
  </table>
  <!--댓글 보여주기-->
  <hr>
  <h3>댓글</h3>
  {% for comment in comments %}
      <p>{{ comment.comment }}</p>
      <form action='{% url "boards:del_comment" comment.id%}' method = 'POST'>
          {% csrf_token %}
         <a href="#" onclick='this.parentNode.submit()'>댓글 삭제</a>
      </form>
  {% empty %}
  <h4>댓글 작성해 주세요~</h4>
  {% endfor %}
  <hr>
  
  <form action='{% url "boards:new_comment" board.id %}' method = 'POST'> <!--부모의 아이디도 같이 넘긴다.-->
      {% csrf_token %}
      {% bootstrap_form comment_form %}
      {% buttons submit="댓글등록" %}
      {% endbuttons %}  
  </form>
  
  
  
  
  {% if user == board.user %} <!--user는 현재 페이지를 띄운 user와 글의 유저(board.user)가 같은 사람인가? 란 뜻-->
  <a href="{% url 'boards:edit' board.id %}">수정하기</a>
  <form action='{% url "boards:delete" board.id %}' method = 'POST'>
      {% csrf_token %}
      <a href="#" onclick="this.parentNode.submit()">삭제하기</a>
      
  </form>
  {% endif %}
  {% endblock %}
  ```

- boards/ urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
      path('edit/<int:b_id>/', views.edit , name = "edit"),
      path('delete/<int:b_id>/' , views.delete , name = 'delete'),
      path('new_comment/<int:b_id>/' , views.new_comment , name='new_comment'),
      path('del_comment/<int:c_id>/' , views.del_comment, name='del_comment'),
  
  ]
  ```

- boards/views.py   

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm , CommentForm
  from .models import Board
  from django.contrib.auth.decorators import login_required
  from django.views.decorators.http import require_POST
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
      comment_form = CommentForm()# 댓글 보내기
  
      comments = board.comment_set.all()   #board에서는 역참고 할때는 _set을 붙여야 한다. 그래서 모든 값을 가져온다.
                                          # 자식입장에서는 부모가 누구인지 명확하기에 comment.board하면 부모를 불러올수 있다.
  
  
      context = {
          'board'  : board,
          'comment_form' : comment_form,
          'comments' : comments,
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  @require_POST #POST로 왔을때만 이 함수 사용 가능!
  def new_comment(request, b_id):
      form = CommentForm(request.POST) #CommentForm에 request.POST내용이 들어 가게 된다.
  
      if form.is_valid(): #댓글이 200자 안으로 잘쓰였는지 확인!
          comment = form.save(commit=False) #DB바로 저장을 막는다!
          comment.board_id = b_id
          comment.user =request.user #현재 페이지를 작성하는 유저, 현재 접속한 user를 불러온다.
          comment.save()
          return redirect('boards:detail', b_id)
      else:
          board = Board.objects.get(id=b_id)
          comments = board.comment_set.all()
          context = {
              'board' : board,
              'comment_form' : form,
              'comments' : comments,
          }
          return render(request, 'boards/detail.html' , context)
  @require_POST
  def del_comment(request, c_id):
      comment = get_object_or_404(Comment, id=c_id)
      board_id = comment.board_id #부모의 아이디를 지우기 전에 변수에 저장
      comment.delete()
      
      return redirect('boards:detail' , board_id)
  ```

- 삭제 확인 해보자~

- 로그인 했을 때만 지워질 수 있게 

- boards/ views.py

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm , CommentForm
  from .models import Board , Comment
  from django.contrib.auth.decorators import login_required
  from django.views.decorators.http import require_POST
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
      comment_form = CommentForm()# 댓글 보내기
  
      comments = board.comment_set.all()   #board에서는 역참고 할때는 _set을 붙여야 한다. 그래서 모든 값을 가져온다.
                                          # 자식입장에서는 부모가 누구인지 명확하기에 comment.board하면 부모를 불러올수 있다.
  
  
      context = {
          'board'  : board,
          'comment_form' : comment_form,
          'comments' : comments,
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  
  @require_POST #POST로 왔을때만 이 함수 사용 가능!
  def new_comment(request, b_id):
      form = CommentForm(request.POST) #CommentForm에 request.POST내용이 들어 가게 된다.
  
      if form.is_valid(): #댓글이 200자 안으로 잘쓰였는지 확인!
          comment = form.save(commit=False) #DB바로 저장을 막는다!
          comment.board_id = b_id
          comment.user =request.user #현재 페이지를 작성하는 유저, 현재 접속한 user를 불러온다.
          comment.save()
          return redirect('boards:detail', b_id)
      else:
          board = Board.objects.get(id=b_id)
          comments = board.comment_set.all()
          context = {
              'board' : board,
              'comment_form' : form,
              'comments' : comments,
          }
          return render(request, 'boards/detail.html' , context)
  @login_required
  @require_POST
  def del_comment(request, c_id):
      comment = get_object_or_404(Comment, id=c_id)
      board_id = comment.board_id #부모의 아이디를 지우기 전에 변수에 저장
      comment.delete()
      
      return redirect('boards:detail' , board_id)
  ```



***

# 1: N의 관계

- user : board = 1:N

- 참조

  - board.user
  - board.user.id
  - board.user.name

- 역참조

  - user.board_set.all()

  - 역참조의 경우 자식의 정보가 없기 때문에 모든걸 불러와야 한다.

  - ```python
    for b in user.board_set.all():
        b.title
        b.content
    ```

### 1:N의 한계점

- 주류라는 테이블에 아이디와 이름이 있을 때.....암튼 한계가 있을때!
- **중계모델**을 만들어서 중계테이블에서 관리를 하게 된다. 그렇게 되면 이것은 N:M의 관계로 성립이 되게 된다. 

# N: M관계

- 좋아요 버튼 누르는 관계
- 다양한 유저가 좋아요를 누를수 있고, 게시글도 여러 유저에게 다양한 좋아요를 받을 수 있다.
- user : board = N:M

### 실습

- model_relation 파일 만들고

- app `onetomany`를 만든다.

- onetomany //models.py

- ```python
  from django.db import models
  
  # Create your models here.
  class User(models.Model):
      name = models.CharField(max_length=20)
      def __str__(self):
          return self.name
  class Board(models.Model):
      title = models.CharField(max_length=100)
      user = models.ForeignKey(User,on_delete=models.CASCADE)
      def __str__(self):
          return self.title
  ```

- migrate 한후

- `pip install django-extensions`설치 후

- settings.py 에 추가해준다. `django_extensions`

- `python manage.py shell_plus`를 해주면

- ```cmd
  
  In [1]:  
  ```

- 뜬다

- ```
  user1 = User.objects.create(name='Kim')
  user2 = User.objects.create(name='Lee')
  board1 = Board.objects.create(title='1글', user=user1)
  board2 = Board.objects.create(title='2글', user=user1)
  board3 = Board.objects.create(title='3글', user=user2)
  c1 = Comment.objects.create(content='1글1댓글', user=user1, board=board1)
  c2 = Comment.objects.create(content='1글2댓글', user=user2, board=board1)
  c3 = Comment.objects.create(content='1글3댓글', user=user1, board=board1)
  c4 = Comment.objects.create(content='1글4댓글', user=user2, board=board1)
  c5 = Comment.objects.create(content='2글1댓글', user=user1, board=board2)
  c6 = Comment.objects.create(content='!1글5댓글', user=user2, board=board1)
  c7 = Comment.objects.create(content='!2글2댓글', user=user2, board=board2)
  ```

- 를 복사해서 `shift + insert`눌러주면 다 붙여 넣기 된다!

### ORM 실습

- 1번 사람이 작성한 게시글을 다 가져오려면?

  - ```cmd
    In [2]: u1 = User.objects.get(id=1)
    #u1에 id가 1인 사람을 모두 넣어 주자~
    ```

  - ```cmd
    In [3]: u1
    Out[3]: <User: Kim> #라고 결과가 나오게 된다~
    ```

  - ```cmd
    In [4]: u1.board_set.all()
    Out[4]: <QuerySet [<Board: 1글>, <Board: 2글>]>
    ```

- 1번 사람이 작성한 모든 글의 댓글을 표시

  - ```cmd
    In [5]: u1_dir=u1.board_set.all()
    
    In [11]: for board in u1_dir:
        ...:     for comment in board.comment_set.all():
        ...:         print(comment.content)
        ...: 
    1글1댓글
    1글2댓글
    1글3댓글
    1글4댓글
    !1글5댓글
    2글1댓글
    !2글2댓글
    #총 7개임을 확인 할 수 있다.
    ```

- 2번째 댓글을 쓴 사람은 누구?

  - ```cmd
    In [15]: com = Comment.objects.get(id=2)
    
    In [16]: com
    Out[16]: <Comment: 1글2댓글>
    
    In [17]: com.user
    Out[17]: <User: Lee>
    
    In [18]: com.user.name
    Out[18]: 'Lee'
    ```

- 2번 댓글을 쓴 사람의 게시글들은?

  - ```cmd
    In [22]: com.user.board_set.all()
    Out[22]: <QuerySet [<Board: 3글>]>
    #유저의 입장에서 자식 board의 자료를 검색하고 싶은 것이기 떄문에 _set
    ```

- 1번 글의 첫번째 댓글을 쓴 사람의 이름?

  - ```cmd
    In [31]: uu = Board.objects.get(id=1)
    
    In [31]: uu.comment_set.first()
    Out[31]: <Comment: 1글1댓글>
    
    In [32]: uu.comment_set.first().user # 첫번째 댓글을 가져오는 것
    Out[32]: <User: Kim>
    
    In [33]: uu.comment_set.get(id=1).user #id의 경우 1이 첫번쨰가 아닐 수 있다. 
    Out[33]: <User: Kim>
    
    In [36]: uu.comment_set.all()[0].user.name #이것도 가능!
    Out[36]: 'Kim'
    ```

- 1번글의 마지막 댓글을 쓴 사람의 이름은?

  - ```cmd
    In [34]: uu.comment_set.last().user
    Out[34]: <User: Lee>
    
    In [35]: uu.comment_set.last().user.name
    Out[35]: 'Lee'
    ```

- 1번글의 2번째 부터 4째까지 댓글을 가지고 오자!

  - ```cmd
    In [48]: uu.comment_set.all()[1:4]
    Out[48]: <QuerySet [<Comment: 1글2댓글>, <Comment: 1글3댓글>, <Comment: 1글4댓글>]>
    
    
    ```

- 1번 글의첫번째, 두 번째 댓글을 가져오면?

  - ```cmd
    In [49]: uu.comment_set.all()[0:2]
    Out[49]: <QuerySet [<Comment: 1글1댓글>, <Comment: 1글2댓글>]>
    ```

- 1번 글의 두번째 댓글을 쓴 사람의 첫번째 게시물의 작성자 이름은?

  - ```cmd
    In [51]: uu.comment_set.all()[1].user.name
    Out[51]: 'Lee' #...???? 사람의 게시물의 작성자는 그 사람이랑 같은거 아닌가?
    
    In [52]: uu.comment_set.all()[1].user.board_set.all()[0].user.name
    Out[52]: 'Lee' 
    ```

- 모든 댓글에서 content정보만 가지고 온다면?

  - ```cmd
    In [53]: Comment.objects.values('content')
    Out[53]: <QuerySet [{'content': '1글1댓글'}, {'content': '1글2댓글'}, {'content': '1글3댓글'}, {'content': '1글4댓글'}, {'content': '2글1댓글'}, {'content': '!1글5댓글'}, {'content': '!2글2댓글'}]>
    ```

- 1번 댓글의 content 정보를 가지고 온다면?

  - ```cmd
    
    In [54]: Comment.objects.values('content').get(id=1)
    Out[54]: {'content': '1글1댓글'}
    
    ######################################################################
    In [49]: c = Comment.objects.values('content').get(id=1)
    
    In [50]: c["content"]
    
    Out[50]: '1글1댓글'
    ```

- 2번 사람이 작성한 댓글을 content의 내림 차순으로 정렬

  - ```cmd
    In [58]: u2 = User.objects.get(id=2)
    
    In [59]: u2.comment_set.order_by('-content')
    Out[59]: <QuerySet [<Comment: 1글4댓글>, <Comment: 1글2댓글>, <Comment: !2글2댓글>, <Comment: !1글5댓글>]>
    ```

- 1글이라는 제목이라는 게시글을 찾아보자.

  - ```cmd
    In [61]: Board.objects.get(title='1글') #get이기 때문에 하나만 나온다.
    Out[61]: <Board: 1글>
    
    In [62]: Board.objects.filter(title='1글') #filter이므로 여러개 나온다.
    Out[62]: <QuerySet [<Board: 1글>]>
    ```

- 글이 포함된 게시글을 찾아보자

  - ```cmd
    In [64]: Board.objects.filter(title__contains='글')
    Out[64]: <QuerySet [<Board: 1글>, <Board: 2글>, <Board: 3글>]>
    ```



### n:m의 관계(중계테이블 이용)

- manytomany  app을 만든다.

- models.py

- ```python
  from django.db import models
  
  # Create your models here.
  class Person(models.Model):
      name = models.CharField(max_length=20)
  
      def __str__(self):
          return f'{self.id}번 술꾼 {self.name}'
  
  class Alcohol(models.Model):
      name = models.CharField(max_length=20)
      #알콜에서는 Person을 설정하지 않으려 한다. 왜냐하면 그렇게 해서 관리되는게 아니기 때문에!
  
      def __str__(self):
          return f'주류 No.{self.id} : {self.name}'
  
  # 1:1은 관리가 어려워 중계모델은 두어야 한다.
  
  class Sales(models.Model):
      person = models.ForeignKey(Person , on_delete=models.CASCADE)
      alcohol = models.ForeignKey(Alcohol , on_delete=models.CASCADE)
  
      def __str__(self):
          return f'{self.person}이 마시는 {self.alcohol}'
  
  
  ```

- migrate시켜준다.

- 그 후 `python manage.py shell_plus`를 실행 한다.

- ```cmd
  In [1]: person1 = Person.objects.create(name="Pengsu")
     ...: person2 = Person.objects.create(name="Sanseul")
     ...: alcohol1 = Alcohol.objects.create(name="Soju")
     ...: alcohol2 = Alcohol.objects.create(name="Beer")
     ...: alcohol3 = Alcohol.objects.create(name="Makgeoly")
     ...: Sales.objects.create(person=person1, alcohol=alcohol1)
     ...: Sales.objects.create(person=person2, alcohol=alcohol2)
     ...: Sales.objects.create(person=person1, alcohol=alcohol2)
  Out[1]: <Sales: 1번 술꾼 Pengsu이 마시는 주류 No.2 : Beer>
  ```

- `shift+insert`해서 넣어주고~

- ```cmd
  In [2]: Sales.objects.all()
  Out[2]: <QuerySet [<Sales: 1번 술꾼 Pengsu이 마시는 주류 No.1 : Soju>, <Sales: 2번 술꾼 Sanseul이 마시는 주류 No.2 : Beer>, <Sales: 1 
  번 술꾼 Pengsu이 마시는 주류 No.2 : Beer>]>
  
  #잘 들어갔는지 확인!
  ```

-  손님 1의 입장에서 판매 정보

  - ```cmd
    In [3]: p1 = Person.objects.get(pk=1)
    
    In [4]: p1
    Out[4]: <Person: 1번 술꾼 Pengsu>
    
    In [7]: p1.sales_set.all()
    Out[7]: <QuerySet [<Sales: 1번 술꾼 Pengsu이 마시는 주류 No.1 : Soju>, <Sales: 1번 술꾼 Pengsu이 마시는 주류 No.2 : Beer>]>
    ```

- 주류 1의 입장에서 판매정보

  - ```cmd
    In [14]: alc1 = Alcohol.objects.get(pk=1)
    
    In [15]: alc1
    Out[15]: <Alcohol: 주류 No.1 : Soju>
    
    In [16]: alc1.sales_set.all()
    Out[16]: <QuerySet [<Sales: 1번 술꾼 Pengsu이 마시는 주류 No.1 : Soju>]>
    #######################################################################
    
    In [8]: Alcohol.objects.get(pk=1).sales_set.all()
    Out[8]: <QuerySet [<Sales: 1번 술꾼 Pengsu이 마시는 주류 No.1 : Soju>]>
    ```

- 주류 2의 입장에서 판매 정보

  - ```cmd
    In [17]: Alcohol.objects.get(pk=2).sales_set.all()
    Out[17]: <QuerySet [<Sales: 2번 술꾼 Sanseul이 마시는 주류 No.2 : Beer>, <Sales: 1번 술꾼 Pengsu이 마시는 주류 No.2 : Beer>]>
    ```

- 손님 1의 주류 목록

  - ```cmd
    In [18]: Person.objects.get(pk=1).sales_set.all()
    Out[18]: <QuerySet [<Sales: 1번 술꾼 Pengsu이 마시는 주류 No.1 : Soju>, <Sales: 1번 술꾼 Pengsu이 마시는 주류 No.2 : Beer>]>
    ```

  - 손님1 sales_set 접근가능

  - sales 주류로 접근 가능

  - ```cmd
    In [19]: for sales in p1.sales_set.all():
        ...:     print(sales.alcohol.name)
        ...: 
    Soju
    Beer
    ```

  - 중계모델을 통해서 간접적으로 찾을 수 있다.!

  - 중계모델 없이 가져오는 방법!

  - models.py에서

  - 가운데 `people = `을 추가한다!!!

  - ```cmd
    from django.db import models
    
    # Create your models here.
    class Person(models.Model):
        name = models.CharField(max_length=20)
    
        def __str__(self):
            return f'{self.id}번 술꾼 {self.name}'
    
    class Alcohol(models.Model):
        name = models.CharField(max_length=20)
        #알콜에서는 Person을 설정하지 않으려 한다. 왜냐하면 그렇게 해서 관리되는게 아니기 때문에!
        people = models.ManyToManyField(Person,through='Sales')
    # ManyToMany(참조할 모델, through="중계모델")
        def __str__(self):
            return f'주류 No.{self.id} : {self.name}'
    
    # 1:1은 관리가 어려워 중계모델은 두어야 한다.
    
    class Sales(models.Model):
        person = models.ForeignKey(Person , on_delete=models.CASCADE)
        alcohol = models.ForeignKey(Alcohol , on_delete=models.CASCADE)
    
        def __str__(self):
            return f'{self.person}이 마시는 {self.alcohol}'
    
    
    
    
    ```

  - migrate하고~

  - 다시 `python manage.py shell_plus`로

- 소주를 마신 사람들

  - ```CMD
    In [1]: alcohol1=Alcohol.objects.get(id=1)
    
    In [2]: alcohol1
    Out[2]: <Alcohol: 주류 No.1 : Soju>
    
    In [3]: alcohol1.people.all()
    Out[3]: <QuerySet [<Person: 1번 술꾼 Pensu>]>
    ```

- 1번 손님이 마신 주류

  - ```cmd
    In [11]: person1 = Person.objects.get(pk=1)
    
    In [12]: person1.alcohol_set.all()
    Out[12]: <QuerySet [<Alcohol: 주류 No.1 : Soju>, <Alcohol: 주류 No.2 : Beer>]>
    ```

  - models.py

  - ```python
    from django.db import models
    
    # Create your models here.
    class Person(models.Model):
        name = models.CharField(max_length=20)
    
        def __str__(self):
            return f'{self.id}번 술꾼 {self.name}'
    
    class Alcohol(models.Model):
        name = models.CharField(max_length=20)
        #알콜에서는 Person을 설정하지 않으려 한다. 왜냐하면 그렇게 해서 관리되는게 아니기 때문에!
        people = models.ManyToManyField(Person,through='Sales', related_name='alcohols')
    
        def __str__(self):
            return f'주류 No.{self.id} : {self.name}'
    
    # 1:1은 관리가 어려워 중계모델은 두어야 한다.
    
    class Sales(models.Model):
        person = models.ForeignKey(Person , on_delete=models.CASCADE)
        alcohol = models.ForeignKey(Alcohol , on_delete=models.CASCADE)
    
        def __str__(self):
            return f'{self.person}이 마시는 {self.alcohol}'
    
    
    ```

  - `related_name='alcohols'`하면 줄임말로 사용 가능

  - 껐다 켜야 적용!

  - ```cmd
    In [1]: person1 =Person.objects.get(pk=1)
    
    In [2]: person1.alcohols.all()
    #person1.alcohol_set.all()은 이제 사용 불가능! 줄임말 설정 해 놓아서
    Out[2]: <QuerySet [<Alcohol: 주류 No.1 : Soju>, <Alcohol: 주류 No.2 : Beer>]>
    ```

- 중계 테이블 쓸데 없는데 없애볼까?

  - models.py

  - ```python
    from django.db import models
    
    # Create your models here.
    class Person(models.Model):
        name = models.CharField(max_length=20)
    
        def __str__(self):
            return f'{self.id}번 술꾼 {self.name}'
    
    class Alcohol(models.Model):
        name = models.CharField(max_length=20)
        #알콜에서는 Person을 설정하지 않으려 한다. 왜냐하면 그렇게 해서 관리되는게 아니기 때문에!
        # people = models.ManyToManyField(Person,through='Sales', related_name='alcohols')
        people = models.ManyToManyField(Person, related_name='alcohols')
    
        def __str__(self):
            return f'주류 No.{self.id} : {self.name}'
    
    # 1:1은 관리가 어려워 중계모델은 두어야 한다.
    
    # class Sales(models.Model):
    #     person = models.ForeignKey(Person , on_delete=models.CASCADE)
    #     alcohol = models.ForeignKey(Alcohol , on_delete=models.CASCADE)
    
    #     def __str__(self):
    #         return f'{self.person}이 마시는 {self.alcohol}'
    
    
    
    
    ```

  - migrations의 cache삭제하고 init빼고 모든걸 지워주자~

  - 중계테이블을 지워도 장고에서 만들어 주기 떄문에

- 중개 테이블에 데이터를 추가하는 방법

  - ```cmd
    person1.alcohols.add(alcohol1)
    alcohhol2.people.add(person1)
    ```

  - ```cmd
    #만약 잘못 들어갔다면!
    person1.alcohols.remove(alcohol2)
    
    person1.alcohols.all()
    #하면 ~~~ 제거됩을 확인 할 수 있따.
    ```

### 좋아요 구현

- django-form 파일의 boards models.py

- ```python
  from django.db import models
  from django.conf import settings
  # Create your models here.
  class Board(models.Model):
      title  = models.CharField(max_length=30)
      content = models.TextField()
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
      like_users = models.ManyToManyField(settings.AUTH_USER_MODEL, related_name="like_boards" , blank=True)
  
      def __str__(self):
          return self.title
  
  class Comment(models.Model):
      comment = models.CharField(max_length=200) #댓글은 대게 200자가 length다.
      user = models.ForeignKey(settings.AUTH_USER_MODEL , on_delete=models.CASCADE) #장고에 있는 기본 settings를 외래키 연결
      board = models.ForeignKey(Board, on_delete=models.CASCADE)
      
      def __str__(self):
          return self.comment
  ```

- migrate시켜주자

- 좋아요 로직 할때 

  - like_users:  좋아요를 누른 유저
  - like_boards : 좋아요가 눌린 게시글

- 사용가능 ORM

  - board.user : 게시글을 작성한 유저
  - board.like_users : 게시글을 좋아요 누른 유저
  - user.board_set.all() : 유저가 작성한 게시글들
  - user.like_boards.all() : 유저가 누른 좋아요 게시글들

- boards/ urls.py

- ```python
  from django.urls import path
  from .import views
  
  app_name='boards'
  
  urlpatterns=[
      path("", views.index, name= 'index'),
      path("new/" , views.new , name = 'new'),
      path('<int:b_id>/' , views.detail , name='detail'),
      path('edit/<int:b_id>/', views.edit , name = "edit"),
      path('delete/<int:b_id>/' , views.delete , name = 'delete'),
      path('new_comment/<int:b_id>/' , views.new_comment , name='new_comment'),
      path('del_comment/<int:c_id>/' , views.del_comment, name='del_comment'),
      path('like/<int:b_id>/', views.like , name='like'),#좋아요 하기 위한!
      
  ]
  ```

- like를 views.py에 추가하게 된다.

- ```python
  from django.shortcuts import render , redirect , get_object_or_404
  from .forms import BoardForm , CommentForm
  from .models import Board , Comment
  from django.contrib.auth.decorators import login_required
  from django.views.decorators.http import require_POST
  
  # Create your views here.
  def index(request):
      boards = Board.objects.all()
  
      context = {
          'boards' : boards
      }
      return render(request , "boards/index.html" , context)
  @login_required
  def new(request):
      #로그인 한사람만 글쓰기 가능!
      # if not request.user.is_authenticated:
      #     return redirect('boards:index')
      #또 다른 방법은 데코레이터! from django.contrib.auth.decorators import login_required 선언 후에
  
  
      if request.method == "POST":
          form = BoardForm(request.POST) #reqeust.POST로 오는 내용이 BoardForm에 담겨 변수에 저장
          if form.is_valid(): #넘어오는 값이 제대로된 값인지 유효성 검사를 해주는것이 is_vaild()
              board = form.save(commit=False) #로 저장해 주면 된다.알아서 폼에서 Board라는 데이터베이스 안에 저장해준다.
              board.user=request.user
              board.save()
              return redirect ('boards:index')
      else:
              
          #form.py를 사용할 것이다.
          form = BoardForm()  #form 변수에 BoardForm 불러왔다.
  
      #data if, else공통 부분
      context= {
          'form' : form
      }
  
      return render(request, "boards/new.html" , context)
  
  def detail(request , b_id):
      board = get_object_or_404(Board, id=b_id) #get 하면 object 하고 못받으면 에러 띄우기이며 (조건작성) 해준다.
      comment_form = CommentForm()# 댓글 보내기
  
      comments = board.comment_set.all()   #board에서는 역참고 할때는 _set을 붙여야 한다. 그래서 모든 값을 가져온다.
                                          # 자식입장에서는 부모가 누구인지 명확하기에 comment.board하면 부모를 불러올수 있다.
  
  
      context = {
          'board'  : board,
          'comment_form' : comment_form,
          'comments' : comments,
      }
      return render(request, 'boards/detail.html' , context)
  
  def edit(request , b_id):
      board = get_object_or_404(Board, id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
  
  
      if request.method =="POST":
          form = BoardForm(request.POST , instance=board) #수정해야 하기 떄문에 instance도 넣어준다.
          if form.is_valid():
              board = form.save()
              return redirect('boards:detail' , board.id) #만약 유효성이 안됐따면 밑에 context로 가게 된다.
      else:
  
          form = BoardForm(instance=board)#board에 있는 값이 채워져서 넘어갈 수 있다. 
  
      #공통 부분
      context = {
          'form' : form
      }
  
      return render(request , 'boards/edit.html' , context)
  
  def delete(request , b_id):
  
      board = get_object_or_404(Board , id=b_id)
  
      if request.user != board.user:
          return redirect('boards:index')
      
      if request.method=="POST":
          board.delete()
          return redirect("boards:index")
      return redirect("boards:detail" , board.id) #삭제 버튼 눌러도 POST아니면 그 페이지에 남아있을 것이다.
  @login_required
  @require_POST #POST로 왔을때만 이 함수 사용 가능!
  def new_comment(request, b_id):
      form = CommentForm(request.POST) #CommentForm에 request.POST내용이 들어 가게 된다.
  
      if form.is_valid(): #댓글이 200자 안으로 잘쓰였는지 확인!
          comment = form.save(commit=False) #DB바로 저장을 막는다!
          comment.board_id = b_id
          comment.user =request.user #현재 페이지를 작성하는 유저, 현재 접속한 user를 불러온다.
          comment.save()
          return redirect('boards:detail', b_id)
      else:
          board = Board.objects.get(id=b_id)
          comments = board.comment_set.all()
          context = {
              'board' : board,
              'comment_form' : form,
              'comments' : comments,
          }
          return render(request, 'boards/detail.html' , context)
  @login_required
  @require_POST
  def del_comment(request, c_id):
      comment = get_object_or_404(Comment, id=c_id)
      board_id = comment.board_id #부모의 아이디를 지우기 전에 변수에 저장
      if request.user == comment.user:
          comment.delete()
      
      return redirect('boards:detail' , board_id)
  
  @login_required
  def like(request, b_id):
      board = get_object_or_404(Board,pk=b_id)
      #좋아요는 누르면 좋아요, 다시 누르면 좋아요 취소
      #좋아요 흔적이 중계모델이 남게 된다. 이를 이용해서 좋아요 로직을 구현하게 된다.
      #중계모델에서 사용자와 게시글 두개를 동시에 가지고 있기 때문에 가능하게 된다.
  
      # if board.like_users.filter(id=request.user.id).exists():    #get으로 찾았을떄 없으면 에러 뜨기 때문에 filter로!
      if request.user in board.like_users.all(): #위아래 둘 중 하나를 사용하자.
          board.like_users.remove(request.user)
      else:
          board.like_users.add(request.user)
      return redirect('boards:index')
  
  ```

- 

#### 템플릿 분할!

- 이쁜 아이콘 쓰기위해 [이곳을]( https://fontawesome.com/icons?d=gallery ) 들어가자 로그인 하면 스크립트 주소가 나오고 그것을 copy하  자! 그리고 이것을 base.html에 넣어 준다.

- boards templates 파일에 _board.html (분할된 파일은 앞에 __ 가 붙게 된다.)

- ![image-20191127163439713](9.FORMs(django6).assets/image-20191127163439713.png)

- ```html
  <div class="card-body">
      <a href="{% url 'boards:like' board.id %}" class="card-link"> 
       <p class="card-text">
           {% if user in board.like_users.all %}
              <i class="fas fa-heart fa-lg" style="color:crimson"></i>
           {% else %}
              <i class="far fa-heart fa-lg" style="color:black"></i>
           {% endif %}</a> <!--꼭 a를 감싸 주자!!!-->
           {{ board.like_users.all|length }} 명이 좋아합니다. 
       </p>
    
  </div>
  ```

- 적용하는 방법은!??

- index.html 에 적용할 거다! `  {% include 'boards/_board.html' %}`를 넣어주면 된다!

- ```html
  {% extends 'base.html' %}
  {% block body %}
  <h1>indexpage</h1>
  <ul>
      {% for board in boards %}
          <li><a href="{% url 'boards:detail' board.id %}">{{board.title}}</a> - {{board.user}}</li>
          {% include 'boards/_board.html' %}
      {% endfor %}
  </ul>
  
  <!--새글쓰기 링크-->
  
  
  
  
  <form action='{% url "accounts:logout" %}' method = 'POST'>
      {% csrf_token %}
      <a href="{% url 'boards:new' %}">New</a><br>
      
  </form>
  
  {% endblock %}
  
  
  
  
  
  
  
  ```

***

## 추가!

> 쿼리셋
>
> 장고는 값이 쓰일때 비로소 쿼리셋을 날리기 때문에 지연, 평가 라고도 한다. 

- ```python
  person =Person.objects.filter(first_name="팽수")
  per=person.order_by()
  person=per.filter().abc().er()
  
  
  #지연? 평가?
  if/for
  for p in person:
      print(p)
      
  for p in person:
      print(p)
      
  city = City.objects.filter(name=인천)
  
  ```

- if 문에서 확인만 필요하고 값을 따로 쓰지 않을떄는 exists()를 사용

  - 캐시에 쿼리셋이 저장이 되지 않음

- 대용량의 데이터를 처리할 떄는 iterator()

- ```python
  rabbits=Rabbit.objects.all()
  
  if rabbits.exists()
  	for rabbit in rabbits.iterator():
          print(rabbit)
          
  ```

- ```cmd
  atom=Atom.objects.all()
  atom_iterator = atom.iterator()
  ```

- ```cmd
  try:
  	first_atom=next(atom_iterator)
  except StopIteration:
  	pass
  else:
  	from itertool import chain
  	
  for atom in chain([first_atom], atom):
  	print(at)
  ```

- 이렇게 하면 iterator하나로 구성을 할 수 있다.






# 실습

[위치](http://bit.do/4th5-pjt-2)

191129_PJT02.pdf

- 위 PDF작성된 내용을 따라 Django 프로젝트를 만들어 보는 실습
- CRUD 작성 및 Image Upload , 1:N , AUth를 연습하는 것이 목적
- Django 프로젝트를 반복적으로 만들어보면서 나중에 자신의 아이디어를 가지고 Django 프로젝트를 만들 수 있는 기반을 마련

  

> - 유저에 대한 기본적인 데이터베이스를 만드는 폼 (creation form)
> - 
>
> 
>
> 







